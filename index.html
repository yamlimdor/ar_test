<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.2/aframe/build/aframe-ar.js"></script>
        <!-- html2canvasライブラリを再度読み込みます -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        
        <title>AR Photo Test</title>
        <style>
            body { margin: 0; overflow: hidden; }

            /* AR体験全体を囲むコンテナ */
            #ar-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* 撮影ボタン */
            #capture-button {
                /* コンテナ内での絶対位置指定に変更 */
                position: absolute; 
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 100; /* 最前面に配置 */
                font-size: 24px;
                padding: 15px 30px;
                border-radius: 50px;
                background-color: white;
                border: 2px solid #333;
                cursor: pointer;
                font-family: sans-serif;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
        </style>
    </head>

    <body>
        <!-- このコンテナがレイアウトの基準となり、表示の崩れを防ぎます -->
        <div id="ar-container">
            <a-scene
                vr-mode-ui="enabled: false;"
                loading-screen="enabled: false;"
                arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
                id="scene"
                embedded
                /* preserveDrawingBufferはhtml2canvasと相性が悪い場合があるため削除 */
                renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; precision: mediump;"
            >
                <a-marker
                    id="animated-marker"
                    type="pattern"
                    preset="custom"
                    url="assets/marker.patt"
                >
                    <a-image
                        src="assets/asset.png"
                        scale="2 2 1"
                        rotation="-90 0 0"
                        position="0 1 0"
                    ></a-image>
                </a-marker>
                <a-entity camera></a-entity>
            </a-scene>

            <!-- 撮影ボタンもコンテナの中に入れる -->
            <button id="capture-button">
                📸 Take Photo
            </button>
        </div>

        <script>
            window.addEventListener('load', () => {
                const arContainer = document.getElementById('ar-container');
                const captureButton = document.getElementById('capture-button');

                // 撮影処理
                captureButton.addEventListener('click', () => {
                    // html2canvasを使って、コンテナ全体をキャプチャする
                    html2canvas(arContainer, {
                        useCORS: true, // 外部リソース（画像など）の読み込みを許可
                        onclone: (clonedDoc) => {
                            // キャプチャする前に、クローンされたDOMから撮影ボタンを非表示にする
                            clonedDoc.getElementById('capture-button').style.display = 'none';
                        }
                    }).then(canvas => {
                        // キャプチャしたcanvasから画像データを生成してダウンロード
                        const dataURL = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.href = dataURL;
                        a.download = 'ar-photo.png';
                        a.click();
                    });
                });
            });
        </script>
    </body>
</html>
