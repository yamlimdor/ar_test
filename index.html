<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.2/aframe/build/aframe-ar.js"></script>
        <!-- html2canvasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å†åº¦èª­ã¿è¾¼ã¿ã¾ã™ -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        
        <title>AR Photo Test</title>
        <style>
            body { margin: 0; overflow: hidden; }

            /* ARä½“é¨“å…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
            #ar-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* æ’®å½±ãƒœã‚¿ãƒ³ */
            #capture-button {
                /* ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®çµ¶å¯¾ä½ç½®æŒ‡å®šã«å¤‰æ›´ */
                position: absolute; 
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 100; /* æœ€å‰é¢ã«é…ç½® */
                font-size: 24px;
                padding: 15px 30px;
                border-radius: 50px;
                background-color: white;
                border: 2px solid #333;
                cursor: pointer;
                font-family: sans-serif;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
        </style>
    </head>

    <body>
        <!-- ã“ã®ã‚³ãƒ³ãƒ†ãƒŠãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åŸºæº–ã¨ãªã‚Šã€è¡¨ç¤ºã®å´©ã‚Œã‚’é˜²ãã¾ã™ -->
        <div id="ar-container">
            <a-scene
                vr-mode-ui="enabled: false;"
                loading-screen="enabled: false;"
                arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
                id="scene"
                embedded
                /* preserveDrawingBufferã¯html2canvasã¨ç›¸æ€§ãŒæ‚ªã„å ´åˆãŒã‚ã‚‹ãŸã‚å‰Šé™¤ */
                renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; precision: mediump;"
            >
                <a-marker
                    id="animated-marker"
                    type="pattern"
                    preset="custom"
                    url="assets/marker.patt"
                >
                    <a-image
                        src="assets/asset.png"
                        scale="2 2 1"
                        rotation="-90 0 0"
                        position="0 1 0"
                    ></a-image>
                </a-marker>
                <a-entity camera></a-entity>
            </a-scene>

            <!-- æ’®å½±ãƒœã‚¿ãƒ³ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã‚Œã‚‹ -->
            <button id="capture-button">
                ğŸ“¸ Take Photo
            </button>
        </div>

        <script>
            window.addEventListener('load', () => {
                const arContainer = document.getElementById('ar-container');
                const captureButton = document.getElementById('capture-button');

                // æ’®å½±å‡¦ç†
                captureButton.addEventListener('click', () => {
                    // html2canvasã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹
                    html2canvas(arContainer, {
                        useCORS: true, // å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆç”»åƒãªã©ï¼‰ã®èª­ã¿è¾¼ã¿ã‚’è¨±å¯
                        onclone: (clonedDoc) => {
                            // ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹å‰ã«ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚ŒãŸDOMã‹ã‚‰æ’®å½±ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                            clonedDoc.getElementById('capture-button').style.display = 'none';
                        }
                    }).then(canvas => {
                        // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸcanvasã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        const dataURL = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.href = dataURL;
                        a.download = 'ar-photo.png';
                        a.click();
                    });
                });
            });
        </script>
    </body>
</html>
